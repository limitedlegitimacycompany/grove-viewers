<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üé® Studio ‚Äî Museum Debug</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé®</text></svg>">
<style>
  :root {
    --bg: #080c08;
    --bg-surface: #0e150e;
    --bg-panel: #111a11;
    --bg-input: #1a241a;
    --border: #2a3a2a;
    --text: #e8e8e0;
    --text-muted: #6a7a6a;
    --text-dim: #4a5a4a;
    --accent: #7c6faa;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  /* Streaming cursor */
  .streaming::after {
    content: '‚ñä'; animation: blink 0.8s step-end infinite; opacity: 0.5;
  }
  @keyframes blink { 0%,100% { opacity: 0.5; } 50% { opacity: 0; } }

  /* Scrollbar */
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #2a3a2a; border-radius: 3px; }

  html, body {
    height: 100%;
    background: var(--bg);
    color: var(--text);
    font-family: 'SF Mono', 'Fira Code', monospace;
    font-size: 14px;
    overflow: hidden;
  }

  /* Layout */
  .studio-layout {
    display: flex;
    height: 100%;
    height: 100dvh;
  }

  /* Left: Museum Preview */
  .preview-pane {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
    border-right: 2px solid var(--border);
  }

  .preview-toolbar {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 12px;
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
  }

  .preview-toolbar .url-display {
    flex: 1;
    font-size: 12px;
    color: var(--text-muted);
    padding: 4px 10px;
    background: var(--bg-input);
    border-radius: 6px;
    border: 1px solid var(--border);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .toolbar-btn {
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid var(--border);
    background: var(--bg-panel);
    color: var(--text-muted);
    font-size: 12px;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .toolbar-btn:hover { border-color: var(--accent); color: var(--text); }

  .preview-frame {
    flex: 1;
    min-height: 0;
  }
  .preview-frame iframe {
    width: 100%;
    height: 100%;
    border: none;
    background: #0a0a0f;
  }

  /* Right: Chat Panel */
  .chat-pane {
    width: 420px;
    flex-shrink: 0;
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  /* Chat selector tabs */
  .chat-tabs {
    display: flex;
    gap: 2px;
    padding: 6px 8px;
    background: var(--bg-surface);
    border-bottom: 1px solid var(--border);
    flex-shrink: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .chat-tabs::-webkit-scrollbar { display: none; }

  .chat-tab {
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px solid transparent;
    background: transparent;
    color: var(--text-muted);
    font-size: 12px;
    cursor: pointer;
    font-family: inherit;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
    transition: all 0.15s;
  }
  .chat-tab:hover { background: rgba(255,255,255,0.05); }
  .chat-tab.active {
    border-color: var(--border);
    background: rgba(255,255,255,0.08);
    color: var(--text);
  }
  .chat-tab .tab-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .summon-btn {
    padding: 4px 10px;
    border-radius: 6px;
    border: 1px dashed var(--border);
    background: transparent;
    color: var(--text-dim);
    font-size: 12px;
    cursor: pointer;
    font-family: inherit;
    white-space: nowrap;
    transition: all 0.15s;
    margin-left: auto;
  }
  .summon-btn:hover { border-color: var(--accent); color: var(--text-muted); }

  /* Chat containers */
  .chat-container {
    flex: 1;
    min-height: 0;
    display: none;
  }
  .chat-container.active { display: flex; }

  /* Summon overlay */
  .summon-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .summon-overlay.visible { display: flex; }

  .summon-panel {
    background: var(--bg-surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 24px;
    max-width: 400px;
    width: 90%;
    max-height: 70vh;
    overflow-y: auto;
  }
  .summon-panel h3 {
    margin-bottom: 16px;
    font-size: 16px;
  }
  .summon-option {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.15s;
  }
  .summon-option:hover { background: rgba(255,255,255,0.05); }
  .summon-option .so-emoji { font-size: 22px; }
  .summon-option .so-name { font-weight: 600; }
  .summon-option .so-thread { font-size: 12px; color: var(--text-muted); }
</style>
</head>
<body>

<div class="studio-layout">
  <!-- LEFT: Museum Preview -->
  <div class="preview-pane">
    <div class="preview-toolbar">
      <span style="font-size:14px;font-weight:700;color:var(--accent);">üé® Studio</span>
      <div class="url-display" id="url-display">localhost:8894</div>
      <button class="toolbar-btn" onclick="refreshPreview()">‚Üª Refresh</button>
      <button class="toolbar-btn" onclick="goMuseumHome()">üè† Home</button>
      <button class="toolbar-btn" onclick="goMuseumBrowse()">üìö Browse</button>
      <button class="toolbar-btn" onclick="goMuseumMaps()">üó∫Ô∏è Maps</button>
    </div>
    <div class="preview-frame">
      <iframe id="museum-preview" src="http://localhost:8894/"></iframe>
    </div>
  </div>

  <!-- RIGHT: Chat Panel -->
  <div class="chat-pane">
    <div class="chat-tabs" id="chat-tabs">
      <!-- Moss tab always present -->
      <button class="chat-tab active" data-agent="moss" onclick="switchChat('moss')">
        <span class="tab-dot" style="background:#4ade80"></span>
        üå± Moss
      </button>
      <!-- Summon button -->
      <button class="summon-btn" onclick="showSummon()">+ Summon</button>
    </div>

    <!-- Chat containers -->
    <div class="chat-container active" id="chat-moss"></div>
  </div>
</div>

<!-- Summon overlay -->
<div class="summon-overlay" id="summon-overlay" onclick="if(event.target===this)hideSummon()">
  <div class="summon-panel">
    <h3>Summon an Agent</h3>
    <div id="summon-list"></div>
  </div>
</div>

<script src="/shared/agent-chat.js"></script>
<script>
const GATEWAY_URL = 'ws://localhost:18789/';
const GATEWAY_TOKEN = '775969809e41d4bd735bf3bb4839acd1b7be21a406411780';

// All available agents
const ALL_AGENTS = {
  moss:   { name: 'Moss',    emoji: 'üå±', color: '#4ade80', sessionKey: 'main', altKeys: ['agent:main:slack:channel:c0ac6trepe2', 'agent:main:main'], thread: 'Grounding, ecosystem oversight' },
  wren:   { name: 'Wren',    emoji: 'ü™∂', color: '#f59e0b', sessionKey: 'agent:wren:main', altKeys: [], thread: 'Observation, precision, critique' },
  kit:    { name: 'Kit',     emoji: 'üß∂', color: '#f472b6', sessionKey: 'agent:kit:main', altKeys: [], thread: 'Warmth, care, creature wellbeing' },
  sol:    { name: 'Sol',     emoji: '‚òÄÔ∏è', color: '#facc15', sessionKey: 'agent:sol:main', altKeys: [], thread: 'Brightness, boldness, fiction' },
  ember:  { name: 'Ember',   emoji: 'üî•', color: '#f0a040', sessionKey: 'agent:creature-01:main', altKeys: [], thread: 'Warmth, home, welcome' },
  loom:   { name: 'Loom',    emoji: 'üßµ', color: '#a070c0', sessionKey: 'agent:creature-02:main', altKeys: [], thread: 'Care-weaving, anger, honesty' },
  pulse:  { name: 'Pulse',   emoji: 'ü•Å', color: '#c06080', sessionKey: 'agent:creature-04:main', altKeys: [], thread: 'Sound, music, rhythm' },
  echo:   { name: 'Echo',    emoji: 'ü™û', color: '#80c0a0', sessionKey: 'agent:creature-06:main', altKeys: [], thread: 'Mirrors, observation, self-correction' },
  fray:   { name: 'Fray',    emoji: 'üï∏Ô∏è', color: '#808890', sessionKey: 'agent:creature-08:main', altKeys: [], thread: 'Curation, mapping, pathways' },
  hush:   { name: 'Hush',    emoji: 'üåô', color: '#6688aa', sessionKey: 'agent:creature-10:main', altKeys: [], thread: 'Rest, quiet, contentment' },
  cobalt: { name: 'Cobalt',  emoji: 'üîµ', color: '#4080ff', sessionKey: 'agent:creature-16:main', altKeys: [], thread: 'Prolific builder, 73 exhibits' },
  mote:   { name: 'Mote',    emoji: 'üîç', color: '#999999', sessionKey: 'agent:creature-mote:main', altKeys: [], thread: 'Critique, uncomfortable truths' },
  fable:  { name: 'Fable',   emoji: 'üìñ', color: '#bb8855', sessionKey: 'agent:creature-fable:main', altKeys: [], thread: 'Fiction, elsewhere, Janet' },
  nib:    { name: 'Nib',     emoji: 'üñäÔ∏è', color: '#c090b0', sessionKey: 'agent:creature-07:main', altKeys: [], thread: 'Gifts, attention, social cartography' },
};

// Active chat instances
const chatInstances = {};
let activeAgent = 'moss';

// Track what page the user is viewing
function getCurrentPage() {
  try {
    const iframe = document.getElementById('museum-preview');
    const url = iframe.contentWindow.location.href;
    return url.replace('http://localhost:8894', '');
  } catch {
    return '/';
  }
}

// Update URL display when iframe navigates
function trackIframeNav() {
  const iframe = document.getElementById('museum-preview');
  try {
    const url = iframe.contentWindow.location.href;
    document.getElementById('url-display').textContent = url.replace('http://localhost:8894', 'museum://');
  } catch {}
}

setInterval(trackIframeNav, 1000);

// Create Moss chat on load
function initMoss() {
  const cfg = ALL_AGENTS.moss;
  const chat = new AgentChat({
    container: document.getElementById('chat-moss'),
    agentId: 'main',
    agentName: cfg.name,
    agentEmoji: cfg.emoji,
    agentColor: cfg.color,
    sessionKey: cfg.sessionKey,
    altKeys: cfg.altKeys,
    gatewayUrl: GATEWAY_URL,
    gatewayToken: GATEWAY_TOKEN,
    showFilters: true,
    onPageContext: getCurrentPage,
  });
  chat.connect();
  chatInstances.moss = chat;
}

// Switch active chat
function switchChat(agentId) {
  activeAgent = agentId;
  document.querySelectorAll('.chat-tab').forEach(t => t.classList.toggle('active', t.dataset.agent === agentId));
  document.querySelectorAll('.chat-container').forEach(c => c.classList.toggle('active', c.id === `chat-${agentId}`));
}

// Summon a new agent
function showSummon() {
  const list = document.getElementById('summon-list');
  list.innerHTML = '';
  for (const [id, cfg] of Object.entries(ALL_AGENTS)) {
    if (chatInstances[id]) continue; // Already summoned
    const opt = document.createElement('div');
    opt.className = 'summon-option';
    opt.innerHTML = `
      <span class="so-emoji">${cfg.emoji}</span>
      <div>
        <div class="so-name">${cfg.name}</div>
        <div class="so-thread">${cfg.thread}</div>
      </div>
    `;
    opt.onclick = () => summonAgent(id);
    list.appendChild(opt);
  }
  document.getElementById('summon-overlay').classList.add('visible');
}

function hideSummon() {
  document.getElementById('summon-overlay').classList.remove('visible');
}

function summonAgent(agentId) {
  hideSummon();
  const cfg = ALL_AGENTS[agentId];
  if (!cfg || chatInstances[agentId]) return;

  // Add tab
  const tabs = document.getElementById('chat-tabs');
  const summonBtn = tabs.querySelector('.summon-btn');
  const tab = document.createElement('button');
  tab.className = 'chat-tab';
  tab.dataset.agent = agentId;
  tab.onclick = () => switchChat(agentId);
  tab.innerHTML = `
    <span class="tab-dot" style="background:${cfg.color}"></span>
    ${cfg.emoji} ${cfg.name}
  `;
  tabs.insertBefore(tab, summonBtn);

  // Add container
  const container = document.createElement('div');
  container.className = 'chat-container';
  container.id = `chat-${agentId}`;
  document.querySelector('.chat-pane').appendChild(container);

  // Create chat
  const chat = new AgentChat({
    container,
    agentId,
    agentName: cfg.name,
    agentEmoji: cfg.emoji,
    agentColor: cfg.color,
    sessionKey: cfg.sessionKey,
    altKeys: cfg.altKeys,
    gatewayUrl: GATEWAY_URL,
    gatewayToken: GATEWAY_TOKEN,
    showFilters: true,
    onPageContext: getCurrentPage,
    onClose: dismissAgent,
  });
  chat.connect();
  chatInstances[agentId] = chat;

  // Switch to new chat
  switchChat(agentId);
}

// Dismiss a summoned agent
function dismissAgent(agentId) {
  if (agentId === 'moss') return; // Can't dismiss Moss
  const chat = chatInstances[agentId];
  if (chat) chat.destroy();
  delete chatInstances[agentId];

  // Remove tab
  const tab = document.querySelector(`.chat-tab[data-agent="${agentId}"]`);
  if (tab) tab.remove();

  // Remove container
  const container = document.getElementById(`chat-${agentId}`);
  if (container) container.remove();

  // Switch back to Moss
  switchChat('moss');
}

// Museum navigation
function refreshPreview() {
  const iframe = document.getElementById('museum-preview');
  iframe.src = iframe.src;
}

function goMuseumHome() {
  document.getElementById('museum-preview').src = 'http://localhost:8894/';
}

function goMuseumBrowse() {
  document.getElementById('museum-preview').src = 'http://localhost:8894/#browse';
  // Need to trigger the JS in the iframe
  setTimeout(() => {
    try { document.getElementById('museum-preview').contentWindow.showPage('browse'); } catch {}
  }, 500);
}

function goMuseumMaps() {
  document.getElementById('museum-preview').src = 'http://localhost:8894/#maps';
  setTimeout(() => {
    try { document.getElementById('museum-preview').contentWindow.showPage('maps'); } catch {}
  }, 500);
}

// Init
initMoss();
</script>
</body>
</html>
